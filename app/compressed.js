"use strict";angular.module("app.winnersView",["ngRoute","ngMaterial"]).config(["$routeProvider",function(a){a.when("/winners",{templateUrl:"views/winners/winners.html",controller:"winnersController",resolve:{auth:["$q","authService",function(a,b){var c=b.getUser();return c?c.finished?a.when(c):a.reject({notFinished:!0}):a.reject({authenticated:!1})}]}})}]).controller("winnersController",["$scope","$location","authService",function(a,b,c){a.init=function(){a.vm={},a.vm.rewards=null,a.user=c.getUser()},a.loadWinners=function(){firebase.database().ref("rewards").once("value").then(function(b){var c=[],d=b.val();d.forEach(function(a){var b=[];a.winners&&a.winners.forEach(function(a){b.push(a)}),a.winners=b,c.push(a)}),a.vm.rewards=c,a.$apply()})},a.init(),a.loadWinners()}]),angular.module("app.stageView",["ngRoute","ngMaterial"]).config(["$routeProvider",function(a){a.when("/stage",{templateUrl:"views/stage/stage.html",controller:"stageController",resolve:{auth:["$q","authService",function(a,b){var c=b.getUser();return c?c.isAdmin?c.finished?a.reject({finished:!0}):a.when(c):a.reject({notAdmin:!0}):a.reject({authenticated:!1})}]}})}]).controller("stageController",["$scope","$location","$rootScope","authService",function(a,b,c,d){a.init=function(){a.vm={},a.vm.entrants=[],a.vm.reward=null,a.vm.loading=!1},a.startAction=function(){a.loading=!0},a.completeAction=function(){a.loading=!1},a.remaining=function(){return a.vm.reward?a.vm.reward.qtd-a.vm.reward.winners.length:0},a.showRaffleButton=function(){return a.vm.entrants.length>0&&a.vm.reward&&!a.vm.reward.finished&&a.vm.reward.qtd>a.vm.reward.winners.length&&!a.loading},a.showFinalizeButton=function(){return a.vm.reward&&!a.vm.reward.finished&&a.vm.reward.qtd==a.vm.reward.winners.length},a.loadEntrants=function(){firebase.database().ref("entrants").once("value").then(function(b){b.val();b.forEach(function(b){var c=b.val();c.award||a.vm.entrants.push(c)}),a.getRewards()})},a.getRewards=function(){firebase.database().ref("rewards").once("value").then(function(e){var f=[],g=e.val();g.forEach(function(a){var b=[];a.winners&&a.winners.forEach(function(a){b.push(a)}),a.winners=b,a.finished||(a.winners=b,a.lastItem=b.length==a.qtd-1,f.push(a))});var h=_.chain(f).sortBy("position").first().value();if(h)a.vm.reward=h,a.$apply();else{var i=d.getUser();i.finished||(i.finished=!0,d.signIn(i),firebase.database().ref("finished").set(!0).then(function(){c.$apply(function(){b.path("/winners")})}))}})},a.raffle=function(){if(a.vm.entrants.length>0&&a.vm.reward.qtd>a.vm.reward.winners.length){a.startAction();var b=a.vm.reward,c=_.random(0,a.vm.entrants.length-1),d=a.vm.entrants[c];d.award={name:b.name,position:c},b.winners||(b.winners=[]),b.winner={position:b.winners.length+1,name:d.name?d.name:d.email,email:d.email};var e={};e["rewards/"+b.id+"/winners/"+b.winner.position]=b.winner,e["entrants/"+d.email.split(".").join("_")]=d,firebase.database().ref().update(e).then(function(){a.completeAction(),a.init(),a.loadEntrants()}).catch(function(b){console.log(b),a.completeAction()})}},a.finalize=function(){a.vm.reward.winners.length==a.vm.reward.qtd&&(a.startAction(),firebase.database().ref("rewards/"+a.vm.reward.id).child("finished").set(!0).then(function(){a.init(),a.loadEntrants(),a.completeAction()}).catch(function(b){console.log(b),a.completeAction()}))},a.remove=function(b,c){a.startAction();var d={},e={},f=_.reject(a.vm.reward.winners,{position:b});_.each(f,function(a,b){delete a.$$hashKey,a.position=b+1,e[a.position]=a}),a.vm.reward.winners=f,d["rewards/"+a.vm.reward.id+"/winners"]=e,d["entrants/"+c.split(".").join("_")+"/award"]=null,firebase.database().ref().update(d).then(function(){a.init(),a.loadEntrants(),a.completeAction()}).catch(function(b){console.log(b),a.completeAction()})},a.init(),a.loadEntrants()}]).config(function(a){a.theme("docs-dark","default").primaryPalette("blue").dark()}),angular.module("app.rewardView",["ngRoute","ngMaterial"]).config(["$routeProvider",function(a){a.when("/reward",{templateUrl:"views/reward/reward.html",controller:"rewardController",resolve:{auth:["$q","authService",function(a,b){var c=b.getUser();return c?c.isAdmin?a.when(c):a.reject({notAdmin:!0}):a.reject({authenticated:!1})}]}})}]).controller("rewardController",["$scope","$location","$rootScope","authService",function(a,b,c,d){a.vm={},a.loading=!1,a.reward=function(){a.loading=!0;var b=a.vm.email.split(".").join("_").toLowerCase();firebase.database().ref("entrants/"+b).child("award").set({name:a.vm.award}).then(function(){a.loading=!1,a.vm={},a.$apply()})}}]).config(function(a){a.theme("docs-dark","default").primaryPalette("blue").dark()}),angular.module("app.loginView",["ngRoute","ngMaterial"]).config(["$routeProvider",function(a){a.when("/login",{templateUrl:"views/login/login.html",controller:"loginController",resolve:{auth:["$q","authService",function(a,b){var c=b.getUser();return c?a.reject({authenticated:!0}):a.when(c)}]}})}]).controller("loginController",["$scope","$location","authService",function(a,b,c){a.vm={login:{}},a.vm.loading=!1,a.login=function(b){c.signIn(b),a.vm.loading=!1,window.location.reload()},a.error=function(b){a.vm.lastError=b},a.initAction=function(){a.error(void 0),a.vm.loading=!0},a.endAction=function(){a.vm.loading=!1,a.$apply()},a.addEntrant=function(b){var c=b.email.split(".").join("_");firebase.database().ref("entrants/"+c).once("value").then(function(d){var e=d.val();e?firebase.database().ref("finished").once("value").then(function(b){e.finished=b.val(),a.login(e)}).catch(function(b){a.error(b.message),a.endAction()}):firebase.database().ref("entrants/"+c).set(b).then(function(){a.login(b),a.endAction()},function(b){a.error(b.message),a.endAction()})}).catch(function(b){a.error(b.message),a.endAction()})},a.openFacebookLogin=function(){var b=new firebase.auth.FacebookAuthProvider;b.addScope("email"),a.initAction(),firebase.auth().signInWithPopup(b).then(function(b){var c=b.user,d={name:c.displayName,email:c.email,photoURL:c.photoURL};a.addEntrant(d)}).catch(function(b){a.error(b.message),a.endAction()})},a.loginEmail=function(){if(a.initAction(),a.vm.login&&a.vm.login.email&&a.vm.login.code){var b=a.vm.login.email.toLowerCase(),c=a.vm.login.code.toLowerCase();firebase.auth().signInWithEmailAndPassword(b,c).then(function(b){var c={name:b.displayName,email:b.email};a.addEntrant(c)}).catch(function(b){"auth/wrong-password"==b.code||"auth/user-not-found"==b.code?a.error("E-mail ou c칩digo inv치lido, por favor tente novamente!"):"auth/invalid-email"==b.code?a.error("E-mail inv치lido!"):a.error(b.message),a.endAction()})}else a.error("Informe o e-mail e seu c칩digo para entrar."),a.endAction()}}]).config(function(a){a.theme("docs-dark","default").primaryPalette("blue").dark()}),angular.module("app.homeView",["ngRoute"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home/home.html",controller:"homeController",resolve:{auth:["$q","authService",function(a,b){var c=b.getUser();return c?c.isAdmin?a.reject({admin:!0}):c.finished?a.reject({finished:!0}):a.when(c):a.reject({authenticated:!1})}]}})}]).controller("homeController",["$scope","authService",function(a,b){a.vm={},a.vm.user=b.getUser(),a.vm.wins=function(){return a.vm.user.award};var c=a.vm.user.email.split(".").join("_");firebase.database().ref("entrants/"+c).on("value",function(c){var d=c.val();b.signIn(d),a.vm.user=d,a.$apply()})}]);var app=angular.module("app",["ngMaterial","ngRoute","app.loginView","app.homeView","app.stageView","app.winnersView","app.rewardView"]);app.config(["$locationProvider","$routeProvider",function(a,b){a.hashPrefix("!"),b.otherwise({redirectTo:"/login"})}]),app.run(function(a,b,c){a.$on("$routeChangeError",function(a,d,e,f){if(f.authenticated===!1)b.path("/login");else if(f.authenticated===!0){var g=c.getUser();g?b.path(g.isAdmin?"/stage":"/home"):b.path("/home")}else f.admin?b.path("/stage"):f.finished?b.path("/winners"):(f.notAdmin||f.notFinished)&&b.path("/home")})}),app.directive("logout",["authService",function(a){return{restrict:"A",link:function(b,c,d){c.bind("click",function(){firebase.auth().signOut().then(function(){a.logout(),location.reload()},function(a){})})}}}]);